<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>上报事件</title>
    <link rel="stylesheet" type="text/css" href="../../../css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../../css/aui1.css" />
    <style type='text/css'>
        html,
        body {
            width: 100%;
            height: 100%;
            background-color: #fff;
        }

        .aui-bar-nav {
            top: 0;
            z-index: 3;
            background-color: #fff;
            color: #333333;
            font-size: var(--fontsize9);
            font-weight: normal;
            font-stretch: normal;
            letter-spacing: 0rem;
            border: none;
            background-size: 100% 1px;
            background-repeat: no-repeat;
            background-position: bottom;
            background-image: linear-gradient(0, #e6e6e6, #e6e6e6 50%, transparent 50%);
            background-image: -webkit-linear-gradient(90deg, #e6e6e6, #e6e6e6 50%, transparent 50%);
        }

        .aui-bar-nav .aui-btn .aui-iconfont {
            color: #333333;
            font-weight: 900;
        }

        .flex-con {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        .content .aui-list {
            background-position: none;
            background-image: none;
        }

        .content .aui-list span {
            color: red;
            line-height: 0.78rem;
        }

        .aui-list.aui-list-in .aui-list-item {
            clear: both;
            background-image: none;
        }

        .aui-list.aui-list-in .aui-list-item:active {
            background: #fff;
        }

        .unusualType,
        .eventType {
            width: 100%;
            min-height: 4.5rem;
            padding-left: 0.75rem;
            /*padding-bottom: 0.75rem;*/
            border: none;
            background-size: 100% 1px;
            background-repeat: no-repeat;
            background-position: 0.75rem bottom;
            ;
            background-image: linear-gradient(0, #dddddd, #dddddd 50%, transparent 50%);
            background-image: -webkit-linear-gradient(90deg, #dddddd, #dddddd 50%, transparent 50%);
            margin-bottom: 0.75rem;
        }

        .eventType {
            min-height: 2.5rem;
        }

        .unusualType1 {
            background-image: none!important;
        }

        .unusualType div {
            float: left;
        }

        .unusualType .titleName,
        .unusualType .inType {
            font-size: 0.7rem;
            color: #333;
            margin-right: 0.53rem;
            margin-bottom: 0.25rem;
            width: 21vw;
            height: 10vw;
            border-radius: 0.13rem;
            border: solid 0.03rem #999999;
            padding: 0.4rem;
        }

        .title-active {
            border: solid 0.03rem #4f79e8!important;
            color: #4f79e8!important;
        }

        .title-img {
            width: 0.8rem;
            height: 0.73rem;
            background: url('../../../image/inspection/checked.png');
            background-size: 0.8rem 0.73rem;
            background-repeat: no-repeat;
            background-position: bottom right;
        }

        .aui-list textarea {
            width: 92vw;
            min-height: 4.6rem;
            background-color: #f5f5f5;
            border-radius: 0.13rem;
            border: solid 0.03rem #cccccc;
            padding-left: 0.75rem;
            padding-top: 0.75rem;
        }

        .aui-col-xs-3 {
            width: 20%;
            margin-right: 0.5rem;
        }

        .aui-col-xs-3 img {
            width: 2.78rem;
            height: 2.78rem;
        }

        .close {
            position: absolute;
            right: 0rem;
            top: -0.3rem;
            width: 16px;
            height: 16px;
            background: url(../../../image/inspection/close.png);
            background-size: 16px 16px;
            background-position: center center;
            background-repeat: no-repeat;
            -webkit-transition: 200ms;
            transition: 200ms;
        }

        .play {
            position: absolute;
            left: 0.79rem;
            top: calc(50% - 0.6rem);
            width: 1.2rem;
            height: 1.2rem;
            background: url(../../../image/inspection/play.png);
            background-size: 100%;
            background-position: center center;
            background-repeat: no-repeat;
            pointer-events: none;
        }

        .closeHide {
            display: none;
        }

        .transformed0 {
            -webkit-transform: rotate(3deg);
            -moz-transform: rotate(3deg);
            -ms-transform: rotate(3deg);
            transform: rotate(3deg);
        }

        .transformed1 {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        .transformed2 {
            -webkit-transform: rotate(357deg);
            -moz-transform: rotate(357deg);
            -ms-transform: rotate(357deg);
            transform: rotate(357deg);
        }

        .aui-pull-right {
            color: #5545F0;
        }

        .aui-list-item,
        .aui-list-item-inner {
            min-height: 1.5rem!important;
        }

        .inputField {
            padding: 0 0.75rem;
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .amountField {
            width: 60vw;
        }

        .inputField input[type="number"],
        .inputField input[type="text"] {
            background-color: #f5f5f5;
            margin: 0;
            padding: 0.45rem 0.4rem;
            height: auto;
            color: #666666;
            font-size: var(--fontsize7);
            font-weight: normal;
            letter-spacing: 0rem;
            line-height: inherit;
            border-radius: 0.13rem;
            border: solid 0.03rem #cccccc;
        }

        .amountField input[type="number"],
        .amountField input[type="text"] {
            width: 80%;
            margin-right: 0.75rem;
        }

        .location {
            width: 1rem;
            height: 1rem;
            background: url("../../../image/inspection/location.png") no-repeat center;
            background-size: 0.65rem 0.8rem;
            margin-left: 0.75rem;
        }

        .aui-list .aui-list-item-title {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>
    <div class="flex-con">
        <header class="aui-bar aui-bar-nav" id="header">
            <div class="aui-pull-left aui-btn" data-action='back'>
                <span class="aui-iconfont aui-icon-left"></span>
            </div>
            <div class="aui-title">上报事件</div>
            <div class="aui-pull-right" tapmode data-action='submitEvent'>确认</div>
        </header>
        <div class="content aui-margin-t-10">
            <ul class="aui-list aui-list-in">
                <li class="aui-list-item">
                    <div class="aui-list-item-inner">
                        <div class="aui-list-item-title"><span>*</span>异常类型:</div>

                    </div>
                </li>
                <div class="unusualType" id="errorType">
                    <!-- <div class="titleName">
                        设备名称
                    </div>
                    <div class="titleName">
                        设备名称
                    </div>
                    <div class="titleName">
                        设备名称
                    </div>
                    <div class="titleName">
                        设备名称
                    </div>
                    <div class="titleName">
                        设备名称
                    </div> -->

                </div>
                <li class="aui-list-item">
                    <div class="aui-list-item-inner">
                        <div class="aui-list-item-title"><span>*</span>事件类型:</div>

                    </div>
                </li>
                <div class="unusualType eventType" id='eventType'>
                    <!-- <div class="inType">
                        其他事件
                    </div> -->
                </div>
                <li class="aui-list-item">
                    <div class="aui-list-item-inner">
                        <div class="aui-list-item-title">预估损失水量:</div>

                    </div>
                </li>
                <div class="inputField amountField">
                    <input type="number" id="predictWaterLoss" />m³
                </div>
                <li class="aui-list-item">
                    <div class="aui-list-item-inner">
                        <div class="aui-list-item-title">设备点坐标:
                            <div class="location" tapmode data-action="getLocation"></div>
                        </div>
                    </div>
                </li>
                <div class="inputField">
                    <input type="text" id="lonAndLat" />
                </div>
                <li class="aui-list-item">
                    <div class="aui-list-item-inner">
                        <div class="aui-list-item-title">地址:</div>
                    </div>
                </li>
                <div class="inputField">
                    <input type="text" id="deviceAddress" />
                </div>
                <li class="aui-list-item">
                    <div class="aui-list-item-inner">
                        <div class="aui-list-item-title">巡检内容:</div>

                    </div>
                </li>
                <div class="unusualType unusualType1">
                    <textarea name="name" id="textareaValue"></textarea>
                </div>
                <li class="aui-list-item">
                    <div class="aui-list-item-inner">
                        <div class="aui-list-item-title">附件:(仅限图片和视频)</div>

                    </div>
                </li>
                <div class='aui-margin-l-15' id="imgPicture">
                    <div class="aui-col-xs-3" tapmode data-action='getPicture'> <img src="../../../image/inspection/file.png" alt=""></div>
                </div>


            </ul>

        </div>
    </div>





</body>
<script type="text/javascript" src="../../../script/api.js"></script>
<script type="text/javascript" src="../../../script/common.js"></script>
<script type="text/javascript" src="../../../script/diy/public.js"></script>
<script type="text/javascript" src="../../../script/remote.js"></script>
<script type="text/javascript" src="../../../script/zepto.js"></script>
<script type="text/javascript" src="../../../script/aui-tab.js"></script>
<script type="text/javascript" src="../../../script/moment.js"></script>
<script type="text/javascript" src="../../../script/hammer.min.js"></script>
<script type="text/javascript" src="../../../script/template.js"></script>
<script type="text/template" id='errorList'>
    {{if type == 'ErrorType'}} {{each items value i}}
    <div class="titleName" data-value='{{value.value}}'>
        {{value.name}}
    </div>
    {{/each}} {{/if}} {{if type == 'EventType'}} {{each items value i}} {{if value.value != 1}}
    <div class="inType" data-value='{{value.value}}'>
        {{value.name}}
    </div>
    {{/if}} {{/each}} {{/if}}
</script>
<script type="text/template" id='pictureList'>
    {{each items value i}}
    <div class="aui-col-xs-3 imgDiv">
        <img class='img1' src="{{value.thumbPath}}" data-param={{value}} tapmode>
        <div class="close closeHide" tapmode data-action="clearImg"></div>
        {{if systemType == 'ios'}} {{if value.mediaType == 'video'}}
        <div class="play"></div>
        {{/if}} {{/if}} {{if systemType == 'android'}} {{if value.videoPath != undefined}}
        <div class="play"></div>
        {{/if}} {{/if}}
    </div> {{/each}}
</script>

<script type="text/javascript">
    var photoBrowser;
    apiready = function() {
        api.addEventListener({
            name: 'changedFontSize'
        }, function(ret, err) {
            if (ret) {
                changeFontSize();
            }
        });
        api.parseTapmode();
        var header = $api.byId('header');
        // 实现沉浸式状态栏效果
        $api.fixStatusBar(header);
        bMap = api.require("bMap");
        var headerH = $api.offset(header).h;
        photoBrowser = api.require('photoBrowser');
        fnReady();
        Init();
        getDictionary();

    }

    var DeviceLongitude = null;
    var DeviceLatitude = null;

    var actionList = {
        'back': function() {
            api.closeWin();
        },
        'getLocation': function() {
            api.showProgress({
                style: 'default',
                animationType: 'fade',
                title: '正在定位中...',
                modal: false
            });
            bMap.getLocation({
                accuracy: '10m',
                autoStop: true,
            }, function(ret, err) {
                if (ret.status) {
                    DeviceLongitude = ret.lon;
                    DeviceLatitude = ret.lat;
                    $("#lonAndLat").val(DeviceLongitude + "," + DeviceLatitude);
                    var complete = false;
                    bMap.getNameFromCoords({
                        lon: ret.lon,
                        lat: ret.lat
                    }, function(ret, err) {
                        if (ret.status) {
                            $("#deviceAddress").val(ret.address);
                        } else {
                            $("#deviceAddress").val("");
                            api.toast({
                                msg: '定位地址失败！',
                                duration: 2000,
                                location: 'bottom'
                            });
                        }
                        api.hideProgress();
                        complete = true;
                    });
                    setTimeout(function() {
                        if (!complete) {
                            api.hideProgress();
                        }
                    }, 5000);
                } else {
                    DeviceLongitude = null;
                    DeviceLatitude = null;
                    $("#deviceAddress").val("");
                    api.toast({
                        msg: '定位坐标失败！',
                        duration: 2000,
                        location: 'bottom'
                    });
                    api.hideProgress();
                }
            });
        },
        'getPicture': function() {
            var UIAlbumBrowser = api.require('UIAlbumBrowser');
            UIAlbumBrowser.open({
                max: 9,
                type: 'all',
                styles: {
                    bg: '#fff',
                    mark: {
                        icon: '',
                        position: 'bottom_left',
                        size: 20
                    },
                    nav: {
                        bg: 'rgba(0,0,0,0.6)',
                        titleColor: '#fff',
                        titleSize: 18,
                        cancelColor: '#fff',
                        cancelSize: 16,
                        finishColor: '#fff',
                        finishSize: 16
                    }
                },
                rotation: true
            }, function(ret) {
                if (ret) {

                    if (ret.eventType == 'confirm') {
                        var list = {
                            items: ret.list,
                            systemType: api.systemType
                        }
                        var str = template('pictureList', list);
                        $('#imgPicture').append(str);
                        longpress();
                        openDetail();
                        addEvenImgOther();
                        api.parseTapmode();
                        operationDom();
                    }
                }
            });
        },
        'clearImg': function() {
            $(this).parent().remove();
            if ($('img').length == 0) {
                clearInterval(timer);
            }
        },
        'submitEvent': function() {
            var locationData = $("#lonAndLat").val().split(",");
            var flag = false;
            if (locationData.length > 1 || $("#lonAndLat").val() == "") {
                flag = true;
            }
            if (!flag) {
                api.toast({
                    msg: '设备点坐标格式有误',
                    duration: 2000,
                    location: 'top'
                });
                return;
            }
            var deviceLongitude = null;
            var deviceLatitude = null;
            if (locationData.length > 1) {
                deviceLongitude = parseFloat(locationData[0]);
                deviceLatitude = parseFloat(locationData[1]);
            }
            var eventType = $('.inType.title-active').attr('data-value');
            var errorType = $('.titleName.title-active').attr('data-value');
            if (errorType == undefined) {
                api.toast({
                    msg: '请先选择异常类型',
                    duration: 2000,
                    location: 'top'
                });
                return;
            }
            if (eventType == undefined) {
                api.toast({
                    msg: '请先选择事件类型',
                    duration: 2000,
                    location: 'top'
                });
                return;
            }
            var submitData = {
                eventType: $('.inType.title-active').attr('data-value'),
                errorType: $('.titleName.title-active').attr('data-value'),
                eventRemark: $('#textareaValue').val(),
                predictWaterLoss: $("#predictWaterLoss").val() == "" ? 0 : $("#predictWaterLoss").val(),
                deviceLongitude: deviceLongitude,
                deviceLatitude: deviceLatitude,
                deviceAddress: $("#deviceAddress").val(),
                fileInfoDtos: []
            };
            var picturePath = [];

            var list = $('.img1');
            for (var i = 0; i < list.length; i++) {
                var data = JSON.parse($(list[i]).attr('data-param'));
                if (api.systemType == 'ios') {
                    UIAlbumBrowser.transVideoPath({
                        path: data.path
                    }, function(ret, err) {
                        if (ret) {
                            if (ret.status) {
                                // console.log(ret.albumVideoPath);
                                picturePath.push(ret.albumVideoPath);
                            }
                        }
                    });
                } else {
                    picturePath.push(data.path);
                }
            }

            var files = {};
            for (var i = 0; i < picturePath.length; i++) {
                files['fileName' + i + ''] = picturePath[i];
            }


            if (picturePath.length != 0) {
                fnPost('UploadFiles/UploadProfilePicture', {
                    files: files
                }, '', true, false, function(ret, err) {
                    if (ret && ret.success) {
                        for (var i = 0; i < ret.result.items.length; i++) {
                            submitData.fileInfoDtos.push(ret.result.items[i]);
                        }
                        fnPost('services/GISInspection/Event/SubmitEvent', {
                            body: JSON.stringify(submitData)
                        }, 'application/json', true, false, function(ret, err) {
                            if (ret && ret.success) {
                                api.toast({
                                    msg: '提交成功！',
                                    duration: 2000,
                                    location: 'top'
                                });
                                api.sendEvent({
                                    name: 'refreshTaskDetails',
                                });

                                setTimeout(function() {
                                    api.closeWin({});
                                }, 300);
                            }
                        })
                    }
                })
            } else {
                fnPost('services/GISInspection/Event/SubmitEvent', {
                    body: JSON.stringify(submitData)
                }, 'application/json', true, false, function(ret, err) {
                    if (ret && ret.success) {
                        api.toast({
                            msg: '提交成功！',
                            duration: 2000,
                            location: 'top'
                        });
                        api.sendEvent({
                            name: 'refreshTaskDetails',
                        });

                        setTimeout(function() {
                            api.closeWin({});
                        }, 300);
                    }
                })
            }
        }
    }

    function Init() {
        $('.titleName,.inType').on('click', function() {
            if ($(this).hasClass('title-active')) {
                $(this).removeClass('title-img').removeClass('title-active');
                $(this).siblings().removeClass('title-active').removeClass('title-img');
            } else {
                $(this).addClass('title-img').addClass('title-active');
                $(this).siblings().removeClass('title-active').removeClass('title-img');
            }
        });
    }

    function getDictionary() {
        var publicDictionaryInputDto = [];
        var tenantId = parseInt($api.getStorage('tenantId'));
        var orgId = parseInt($api.getStorage('orgId'));
        var productId = parseInt($api.getStorage('insepProductId'));
        var errorType = {
            tenantId: tenantId,
            orgId: orgId,
            productId: productId,
            cateCode: 'ErrorType'
        }
        publicDictionaryInputDto.push(errorType);
        var eventType = {
            tenantId: tenantId,
            orgId: orgId,
            productId: productId,
            cateCode: 'EventType'
        }
        publicDictionaryInputDto.push(eventType)
        fnPost('services/app/Authorization/PostPublicDictionarys', {
            body: JSON.stringify({
                publicDictionaryInputDto: publicDictionaryInputDto
            })
        }, 'application/json', true, false, function(ret, err) {
            if (ret) {
                if (ret.success) {
                    var data = ret.result;
                    for (var i = 0; i < data.length; i++) {
                        if (data[i].dictionaryCate.cateCode == 'ErrorType') {
                            var list = {
                                type: 'ErrorType',
                                items: data[i].dictionaryList
                            };
                            var str = template('errorList', list);
                            $('#errorType').append(str);
                        } else if (data[i].dictionaryCate.cateCode == 'EventType') {
                            var list = {
                                type: 'EventType',
                                items: data[i].dictionaryList
                            };
                            var str = template('errorList', list);
                            $('#eventType').append(str);
                        }
                    }
                    Init();
                }
            }
        })
    }

    var timer;

    function longpress() {
        var list = $api.domAll('.img1');
        for (var i = 0; i < list.length; i++) {
            var hammer = new Hammer(list[i]);
            hammer.get('press').set({
                time: 300
            });
            hammer.on("press", function(e) {
                $('.close').show();
                var dom = $(e.target);
                direction = 1; // 1, -1
                state = 1; // 0,1,2
                oldClass = "";
                clearInterval(timer);
                timer = setInterval(function() {
                    $('.img1').parent().removeClass(oldClass);
                    if (state + direction > 2 || state + direction < 0) {
                        direction = -direction;
                    }
                    state = state + direction;
                    newClass = "transformed" + state;
                    // console.log("set new class to " + newClass);
                    $('.img1').parent().addClass(newClass);
                    $('.img1').parent().innerText = newClass;
                    oldClass = newClass;
                }, 85);
            });

        }
    }

    function openDetail() {
        var list = $api.domAll('.img1');
        for (var i = 0; i < list.length; i++) {
            var hammer = new Hammer(list[i]);
            hammer.on("tap", function(ret) {
                var dom = $(ret.target);
                var data = JSON.parse(dom.attr('data-param'));
                var imgList = $('.img1');
                var allImgData = [];
                var activeIndex = 0;
                for (var j = 0; j < imgList.length; j++) {
                    var imgData = JSON.parse($(imgList[j]).attr('data-param'));
                    if (imgData.videoPath == undefined) {
                        allImgData.push(imgData.path);
                        if (imgData.path == data.path) {
                            activeIndex = j;
                        }
                    }
                }
                if (api.systemType == 'ios') {
                    if (data.mediaType == 'video') {
                        UIAlbumBrowser.transVideoPath({
                            path: data.path
                        }, function(ret, err) {
                            if (ret) {
                                if (ret.status) {
                                    // console.log(ret.albumVideoPath);
                                    api.openVideo({
                                        url: ret.albumVideoPath
                                    });
                                }
                            }
                        });
                    } else {
                        for (var k = 0; k < allImgData.length; k++) {
                            UIAlbumBrowser.transPath({
                                path: allImgData[k]
                            }, function(ret, err) {
                                if (ret) {
                                    allImgData[k] = ret.path
                                }
                            });
                        }
                        photoBrowser.open({
                            images: allImgData,
                            activeIndex: activeIndex,
                            placeholderImg: 'widget://res/img/apicloud.png',
                            bgColor: '#000'
                        }, function(ret, err) {
                            if (ret) {
                                $api.setStorage('isPhotoView', true);
                                if (ret.eventType == 'click') {
                                    photoBrowser.close();
                                    $api.rmStorage('isPhotoView');
                                }
                            }
                        });
                    }
                } else {
                    if (data.videoPath != undefined) {
                        api.openVideo({
                            url: data.videoPath
                        });
                    } else {
                        photoBrowser.open({
                            images: allImgData,
                            activeIndex: activeIndex,
                            placeholderImg: 'widget://res/img/apicloud.png',
                            bgColor: '#000'
                        }, function(ret, err) {
                            if (ret) {
                                $api.setStorage('isPhotoView', true);
                                if (ret.eventType == 'click') {
                                    photoBrowser.close();
                                    $api.rmStorage('isPhotoView');
                                }
                            }
                        });
                    }
                }
            })
        }
    }

    function addEvenImgOther() {
        var imgDiv = $api.domAll('.imgDiv');
        for (var i = 0; i < imgDiv.length; i++) {
            $api.addEvt(imgDiv[i], 'touchstart', function(event) {
                event = event || window.event;
                event.stopPropagation();
            });
        }
        //  监听图片外的单击
        document.addEventListener('touchstart', function() {
            $('.close').hide();
            clearInterval(timer);
            $('img').parent().removeClass('transformed0 transformed1 transformed2');
        });

    }
</script>

</html>
