<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
    <title>抄表考核统计页面</title>
    <link rel="stylesheet" type="text/css" href="../../../css/aui1.css" />
    <link rel=stylesheet type=text/css href=../../../css/rolldate.css />
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            background-color: #F0F0F0;
            -webkit-box-orient: vertical;
            -webkit-flex-flow: column;
            flex-flow: column;
            display: flex;
            overflow-x: hidden;
        }

        .aui-bar-nav {
            top: 0;
            z-index: 1;
            background-color: #0c9ff4;
            color: #FFF;
            font-size: var(--fontsize9);
            font-weight: normal;
            font-stretch: normal;
            letter-spacing: 0rem;
        }

        .aui-bar-nav .aui-btn .aui-iconfont {
            color: #FFF;
            font-weight: 900;
        }

        .aui-tab {
            width: 100%;
            border-bottom: solid 0.03rem #e6e6e6;
        }

        .aui-tab-item {
            font-size: var(--fontsize7);
            font-weight: normal;
            font-stretch: normal;
            letter-spacing: 0vw;
            color: #333333;
        }

        .aui-tab-item.aui-active {
            border-bottom: 0.05rem solid #0c9ff4;
        }

        .aui-tab-item.aui-active,
        .aui-tab-item.aui-active .aui-iconfont {
            color: #0c9ff4;
        }

        .aui-tab-item .aui-iconfont {
            color: #999999;
            font-weight: 900;
            margin-left: 0.15rem;
        }

        .aui-card-list-header {
            padding: 4.13vw 3.2vw;
            font-size: var(--fontsize8);
            font-weight: normal;
            font-stretch: normal;
            letter-spacing: 0vw;
            color: #262626;
        }

        .timeIcon {
            width: 4.27vw;
            height: 4.27vw;
            background-image: url('../../../image/decision/time.png');
            background-size: 100% 100%;
        }

        .aui-card-list-header input {
            width: 74.67vw;
            height: 7.73vw;
            border-radius: 0.4vw;
            border: solid 1px #dcdcdc;
            font-size: var(--fontsize7);
            font-weight: normal;
            font-stretch: normal;
            letter-spacing: 0.4vw;
            color: #262626;
            padding: 2vw 3.33vw;
        }

        .downArrow {
            width: 2.93vw;
            height: 1.6vw;
            position: absolute;
            top: 7.2vw;
            right: 6.27vw;
            background-image: url('../../../image/decision/downArrow.png');
            background-size: 100% 100%;
        }

        .close {
            width: 4.0vw;
            height: 4.0vw;
            position: absolute;
            top: 6vw;
            right: 12vw;
            background-image: url('../../../image/message_frame/close2.png');
            background-size: 100% 100%;
        }

        section {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .aui-card-list {
            border-radius: 1.33vw;
        }

        .line {
            width: 0.8vw;
            height: 4vw;
            background-color: #0c9ff4;
            margin-right: 2vw;
        }

        section .aui-card-list-header {
            padding: 2.67vw 3.2vw;
        }

        .aui-card-list-user-name {
            justify-content: space-between;
            font-size: var(--fontsize7);
            font-weight: normal;
            font-stretch: normal;
            letter-spacing: 0vw;
            color: #0c9ff4;
        }

        .aui-card-list-user-name .left {
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .aui-card-list-user-name a {
            color: #0c9ff4;
            float: right;
        }

        .noData {
            width: 100%;
            height: 30vw;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--fontsize7);
            font-weight: normal;
            font-stretch: normal;
            letter-spacing: 0vw;
            color: #0c9ff4;
        }

        .aui-card-list-header.aui-card-list-user .aui-col-xs-4 {
            font-size: var(--fontsize7);
            font-weight: 800;
            font-stretch: normal;
            letter-spacing: 0vw;
            color: #333333;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
        }

        #table {
            padding: 2vw 0.75rem;
        }

        .row {
            height: 5.2vw;
            padding: 2vw 0;
        }

        .row .aui-col-xs-4 {
            font-size: var(--fontsize7);
            font-weight: normal;
            font-stretch: normal;
            letter-spacing: 0vw;
            color: #333333;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
        }
    </style>
</head>

<body>
    <header class="aui-bar aui-bar-nav" id="header">
        <div class="aui-pull-left aui-btn" tapmode data-action='back'>
            <span class="aui-iconfont aui-icon-left"></span>
        </div>
        <div class="aui-title">抄表员考核统计</div>
    </header>
    <div class="aui-tab" id="tab">
        <div class="aui-tab-item aui-active">抄表率</div>
        <div class="aui-tab-item">回收率</div>
    </div>

    <div class="aui-card-list">
        <div class="aui-card-list-header">
            <div class="timeIcon"></div>时间：
            <input tapmode placeholder="请选择时间" type="text" name="input_date" id="Time" readonly="readonly" />
            <div class="downArrow"></div>
        </div>
    </div>

    <section id="MeterReadingRate">
        <div class="aui-card-list">
            <div class="aui-card-list-header aui-card-list-user aui-border-b">
                <div class="aui-col-xs-4">
                    姓名
                </div>
                <div class="aui-col-xs-4">
                    应抄
                </div>
                <div class="aui-col-xs-4">
                    实抄
                </div>
            </div>
            <div class="aui-card-list-content-padded" id="MeterReadingRateTable">
            </div>
        </div>

        <div class="aui-card-list">

            <div class="aui-card-list-header aui-card-list-user">
                <div class="aui-card-list-user-name">
                    <div class="left">
                        <div class="line">
                        </div>当月抄表率
                    </div>
                    <a tapmode data-action="MeterReadingRateMore">更多</a>
                </div>
            </div>

            <div class="aui-card-list-content-padded">
                <div id="MeterReadingRateEchart" style="width:90vw;height:60vw">
                </div>
                <div class="noData">
                    暂无数据！
                </div>
            </div>

        </div>

        <div class="aui-card-list">

            <div class="aui-card-list-header aui-card-list-user">
                <div class="aui-card-list-user-name">
                    <div class="left">
                        <div class="line">
                        </div>抄表明细
                    </div>
                </div>
            </div>

            <div class="aui-card-list-content-padded">
                <div id="MeterReadingRateDetails" style="width:90vw">
                </div>
                <div class="noData">
                    暂无数据！
                </div>
            </div>

        </div>
    </section>

    <section id="RecoveryRate">
        <div class="aui-card-list">
            <div class="aui-card-list-header aui-card-list-user aui-border-b">
                <div class="aui-col-xs-4">
                    姓名
                </div>
                <div class="aui-col-xs-4">
                    应收
                </div>
                <div class="aui-col-xs-4">
                    实收
                </div>
            </div>
            <div class="aui-card-list-content-padded" id="RecoveryRateTable">
            </div>
        </div>

        <div class="aui-card-list">

            <div class="aui-card-list-header aui-card-list-user">
                <div class="aui-card-list-user-name">
                    <div class="left">
                        <div class="line">
                        </div>当月回收率
                    </div>
                    <a tapmode data-action="RecoveryRateMore">更多</a>
                </div>
            </div>

            <div class="aui-card-list-content-padded">
                <div id="RecoveryRateEchart" style="width:90vw;;height:60vw">
                </div>
                <div class="noData">
                    暂无数据！
                </div>
            </div>

        </div>

        <div class="aui-card-list">

            <div class="aui-card-list-header aui-card-list-user">
                <div class="aui-card-list-user-name">
                    <div class="left">
                        <div class="line">
                        </div>回收详细
                    </div>
                </div>
            </div>

            <div class="aui-card-list-content-padded">
                <div id="RecoveryRateDetails" style="width:90vw">
                </div>
                <div class="noData">
                    暂无数据！
                </div>
            </div>

        </div>
    </section>

</body>
<script type="text/javascript" src="../../../script/api.js"></script>
<script type="text/javascript" src="../../../script/common.js"></script>
<script type="text/javascript" src="../../../script/zepto.js"></script>
<script type="text/javascript" src="../../../script/diy/public.js"></script>
<script type="text/javascript" src="../../../script/aui-tab.js"></script>
<script type="text/javascript" src="../../../script/rolldate.js"></script>
<script type="text/javascript" src="../../../script/moment.js"></script>
<script type="text/javascript" src="../../../script/remote.js"></script>
<script type="text/javascript" src="../../../script/echarts.min.js"></script>
<script type="text/javascript" src="../../../script/diy/template.js"></script>
<script type="text/template" id="tableTpl">
    {{each items value i}}
    <div class="row">
        <div class="aui-col-xs-4">
            {{value.name}}
        </div>
        <div class="aui-col-xs-4">
            {{value.shouldCopy}}
        </div>
        <div class="aui-col-xs-4">
            {{value.actualCopy}}
        </div>
    </div>
    {{/each}}
</script>
<script type="text/javascript">
    document.body.addEventListener('touchstart', function() {});
    apiready = function() {
        api.addEventListener({
            name: 'changedFontSize'
        }, function(ret, err) {
            if (ret) {
                changeFontSize();
            }
        });
        api.parseTapmode();
        var header = $api.byId('header');
        // 实现沉浸式状态栏效果
        $api.fixStatusBar(header);
        headerH = $api.offset(header).h;
        fnReady();
        $('#MeterReadingRate').show();
        $('#RecoveryRate').hide();
        $('#MeterReadingRateEchart').hide();
        $('#RecoveryRateEchart').hide();
        getActualCopyRateByMonth();
    };

    var index = 1;

    var tab = new auiTab({
        element: document.getElementById("tab"),
    }, function(ret) {
        if (ret.index == 1) {
            index = 1;
            $('#MeterReadingRate').show();
            $('#RecoveryRate').hide();
            getActualCopyRateByMonth();
        } else if (ret.index == 2) {
            index = 2;
            $('#MeterReadingRate').hide();
            $('#RecoveryRate').show();
            getRealIncomeRateByMonth();
        }
    });

    TimeInit('Time');

    var Time = "";
    //时间选择器
    function TimeInit(inputId) {
        var el = '#' + inputId;
        var format = "YYYY-MM";
        var dateError = false;
        new rolldate.Date({
            el: el,
            format: format,
            beginYear: 2000,
            endYear: 2100,
            tapBefore: function(el) {
                // console.log('插件开始触发');
            },
            moveEnd: function(el, iscroll) {
                // console.log('滚动结束');
            },
            confirmBefore: function(el, date) {
                Time = date;
                Time = Time.replaceAll('-', '');
                var closeHtml = '<div class="close" tapmode onclick="clearTime(&quot;' + inputId + '&quot;)"></div>';
                $('#' + inputId + '').parent().append(closeHtml);
                if (index == 1) {
                    getActualCopyRateByMonth();
                } else {
                    getRealIncomeRateByMonth();
                }
                return date.replaceAll('-', '/');
            },
            confirmEnd: function(el, date) {

            }
        })
    }

    //点击关闭图标删除时间
    function clearTime(inputId) {
        $('#' + inputId + '').val("");
        $('#' + inputId + '').parent().find('.close').remove();
        Time = "";
        if (index == 1) {
            getActualCopyRateByMonth();
        } else {
            getRealIncomeRateByMonth();
        }
    }


    var actionList = {
        'back': function() {
            api.closeWin();
        },
        'MeterReadingRateMore': function() {
            if (userList.length == 0) {
                api.toast({
                    msg: '暂无数据！',
                    duration: 2000,
                    location: 'top'
                });
            } else {
                api.openWin({
                    name: 'MeterReadingRateMore',
                    url: './MeterReadingRateMore.html',
                    pageParam: {
                        Time: Time,
                        nameData: userList
                    }
                });
            }
        },
        'RecoveryRateMore': function() {
            if (userList.length == 0) {
                api.toast({
                    msg: '暂无数据！',
                    duration: 2000,
                    location: 'top'
                });
            } else {
                api.openWin({
                    name: 'RecoveryRateMore',
                    url: './RecoveryRateMore.html',
                    pageParam: {
                        Time: Time,
                        nameData: userList
                    }
                });
            }
        }
    }

    var userList = [];
    //获取抄表率
    function getActualCopyRateByMonth() {
        var url = 'services/Report/MeterReadingPerson/GetActualCopyRateByMonth';
        if (Time != "") {
            url = url + '?date=' + Time + '';
        } else {
            var time = moment().format('YYYYMM');
            url = url + '?date=' + time + '';
        }
        fnGet(url, {}, false, function(ret, err) {
            if (ret) {
                if (ret.success) {
                    userList = [];
                    var nameData = [];
                    var detailsNameData = [];
                    var data = [];
                    var detailsData1 = [];
                    var detailsData2 = [];
                    var barautoHeight = 0;
                    if (ret.result != null) {
                        $('#MeterReadingRateEchart').show();
                        $('#MeterReadingRateEchart').next('.noData').hide();
                        $('#MeterReadingRateDetails').next('.noData').hide();
                        detailsNameData = ret.result.nameList;
                        userList = ret.result.nameList;
                        detailsData1 = ret.result.shouldCopyList;
                        detailsData2 = ret.result.actualCopyList;
                        data = ret.result.shouldCopyRateList;
                        for (var i = 0; i < data.length; i++) {
                            nameData.push(data[i].name);
                        }
                        // console.log(JSON.stringify(detailsNameData));
                        barautoHeight = detailsNameData.length * 70 + 80;
                        var list = {
                            items: ret.result.dataList
                        };
                        var str = template('tableTpl', list);
                        $('#MeterReadingRateTable').html(str);
                    } else {
                        $('#MeterReadingRateEchart').hide();
                        $('#MeterReadingRateEchart').next('.noData').show();
                        $('#MeterReadingRateDetails').next('.noData').show();
                        var list = {
                            items: []
                        };
                        var str = template('tableTpl', list);
                        $('#MeterReadingRateTable').html(str);
                    }
                    var piechartName = echarts.init(document.getElementById("MeterReadingRateEchart"));
                    var barchartName = echarts.init(document.getElementById("MeterReadingRateDetails"));
                    baroption = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'line',
                                shadowStyle: {
                                    color: 'rgba(12,159,244,0.3)'
                                }
                            }
                        },
                        legend: {
                            orient: 'horizontal',
                            icon: 'circle',
                            x: 'right',
                            data: ['应抄', '实抄']
                        },
                        color: ['#3eb4fc', '#e392ed'],
                        grid: {
                            left: '3%',
                            right: '15%',
                            bottom: 10,
                            top: 30,
                            containLabel: true
                        },
                        xAxis: {
                            type: 'value',
                            axisLabel: {
                                rotate: 40
                            },
                            name: '(户数)',
                            nameLocation: 'end'
                        },
                        yAxis: {
                            type: 'category',
                            data: detailsNameData,
                            axisLabel: {
                                interval: 0,
                                formatter: function(value) {
                                    if (value.length > 5) {
                                        return value.substring(0, 5) + "...";
                                    } else {
                                        return value;
                                    }
                                }
                            }
                        },
                        series: [{
                            name: '应抄',
                            type: 'bar',
                            barWidth: '20',
                            data: detailsData1
                        }, {
                            name: '实抄',
                            type: 'bar',
                            barWidth: '20',
                            data: detailsData2
                        }]
                    };
                    pieoption = {
                        tooltip: {
                            trigger: 'item',
                            formatter: "{a} <br/>{b}: {c} ({d}%)"
                        },
                        legend: {
                            orient: 'horizontal',
                            icon: 'circle',
                            x: '10%',
                            y: '80%',
                            bottom: '25%',
                            data: nameData
                        },
                        color: ['#2BB0FD', '#10E1C4', '#7FD709', '#FDEF4D', '#FDC963', '#FFA75D', '#FD7A72', '#FE4747', '#FF61D2', '#B962FE', '#5B5AE9', '#2A8AFB'],
                        series: [{
                            name: '抄表率',
                            type: 'pie',
                            radius: ['40%', '60%'],
                            center: ['50%', '40%'],
                            avoidLabelOverlap: false,
                            label: {
                                normal: {
                                    show: false,
                                    position: 'center'
                                },
                                emphasis: {
                                    show: true,
                                    textStyle: {
                                        fontSize: '30',
                                        fontWeight: 'bold'
                                    }
                                }
                            },
                            labelLine: {
                                normal: {
                                    show: false
                                }
                            },
                            data: data
                        }]
                    };
                    barchartName.setOption(baroption);
                    barchartName.getDom().style.height = barautoHeight + "px";
                    barchartName.resize();
                    piechartName.setOption(pieoption);
                }
            }
        })
    }

    //获取回收率
    function getRealIncomeRateByMonth() {
        var url = 'services/Report/MeterReadingPerson/GetRealIncomeRateByMonth';
        if (Time != "") {
            url = url + '?date=' + Time + '';
        } else {
            var time = moment().format('YYYYMM');
            url = url + '?date=' + time + '';
        }
        fnGet(url, {}, false, function(ret, err) {
            if (ret) {
                if (ret.success) {
                    userList = [];
                    var nameData = [];
                    var detailsNameData = [];
                    var data = [];
                    var detailsData1 = [];
                    var detailsData2 = [];
                    var barautoHeight = 0;
                    if (ret.result != null) {
                        $('#RecoveryRateEchart').show();
                        $('#RecoveryRateEchart').next('.noData').hide();
                        $('#RecoveryRateDetails').next('.noData').hide();
                        detailsNameData = ret.result.nameList;
                        userList = ret.result.nameList;
                        detailsData1 = ret.result.shouldCopyList;
                        detailsData2 = ret.result.actualCopyList;
                        data = ret.result.shouldCopyRateList;
                        for (var i = 0; i < data.length; i++) {
                            nameData.push(data[i].name);
                        }
                        barautoHeight = detailsNameData.length * 70 + 80;
                        var list = {
                            items: ret.result.dataList
                        };
                        var str = template('tableTpl', list);
                        $('#RecoveryRateTable').html(str);
                    } else {
                        $('#RecoveryRateEchart').hide();
                        $('#RecoveryRateEchart').next('.noData').show();
                        $('#RecoveryRateDetails').next('.noData').show();
                        var list = {
                            items: []
                        };
                        var str = template('tableTpl', list);
                        $('#RecoveryRateTable').html(str);
                    }
                    var piechartName = echarts.init(document.getElementById("RecoveryRateEchart"));
                    var barchartName = echarts.init(document.getElementById("RecoveryRateDetails"));
                    baroption = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'line',
                                shadowStyle: {
                                    color: 'rgba(12,159,244,0.3)'
                                }
                            }
                        },
                        legend: {
                            orient: 'horizontal',
                            icon: 'circle',
                            x: 'right',
                            data: ['应收', '实收']
                        },
                        color: ['#3eb4fc', '#e392ed'],
                        grid: {
                            left: '3%',
                            right: '15%',
                            bottom: 10,
                            top: 30,
                            containLabel: true
                        },
                        xAxis: {
                            type: 'value',
                            axisLabel: {
                                rotate: 40
                            },
                            name: '(元)',
                            nameLocation: 'end'
                        },
                        yAxis: {
                            type: 'category',
                            data: detailsNameData,
                            axisLabel: {
                                interval: 0
                            }
                        },
                        series: [{
                            name: '应收',
                            type: 'bar',
                            barWidth: '20',
                            data: detailsData1
                        }, {
                            name: '实收',
                            type: 'bar',
                            barWidth: '20',
                            data: detailsData2
                        }]
                    };
                    pieoption = {
                        tooltip: {
                            trigger: 'item',
                            formatter: "{a} <br/>{b}: {c} ({d}%)"
                        },
                        legend: {
                            orient: 'horizontal',
                            icon: 'circle',
                            x: '10%',
                            y: '80%',
                            bottom: '25%',
                            data: nameData
                        },
                        color: ['#2BB0FD', '#10E1C4', '#7FD709', '#FDEF4D', '#FDC963', '#FFA75D', '#FD7A72', '#FE4747', '#FF61D2', '#B962FE', '#5B5AE9', '#2A8AFB'],
                        series: [{
                            name: '回收率',
                            type: 'pie',
                            radius: ['40%', '60%'],
                            center: ['50%', '40%'],
                            avoidLabelOverlap: false,
                            label: {
                                normal: {
                                    show: false,
                                    position: 'center'
                                },
                                emphasis: {
                                    show: true,
                                    textStyle: {
                                        fontSize: '30',
                                        fontWeight: 'bold'
                                    }
                                }
                            },
                            labelLine: {
                                normal: {
                                    show: false
                                }
                            },
                            data: data
                        }]
                    };
                    barchartName.setOption(baroption);
                    barchartName.getDom().style.height = barautoHeight + "px";
                    barchartName.resize();
                    piechartName.setOption(pieoption);
                }
            }
        })
    }
</script>

</html>
